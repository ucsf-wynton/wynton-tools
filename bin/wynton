#! /usr/bin/env bash
#' UCSF Wynton HPC Command Line Tools
#' 
#' Usage:
#'  wynton <tool> ...
#' 
#' Installed tools:
#' {{table_of_tools}}
#'
#' Example:
#'  wynton --help
#'
#' Version: 0.23.3
#' Copyright: Henrik Bengtsson (2019-2025)
#' License: GPL (>= 2.1) [https://www.gnu.org/licenses/gpl.html]
#' Source: https://github.com/ucsf-wynton/wynton-tools

# shellcheck disable=2034
call="$0 $*"

this="${BASH_SOURCE%/}"
[[ -L "${this}" ]] && this=$(readlink "${this}")

## Import bash utility functions
incl="$(dirname "${this}")/incl"

# shellcheck source=incl/asserts.sh
source "${incl}/asserts.sh"
# shellcheck source=incl/cli.sh
source "${incl}/cli.sh"
# shellcheck source=incl/conditions.sh
source "${incl}/conditions.sh"
# shellcheck source=incl/files.sh
source "${incl}/files.sh"
# shellcheck source=incl/output.sh
source "${incl}/output.sh"
# shellcheck source=incl/system.sh
source "${incl}/system.sh"

UCSF_WYNTON_DIR=$(dirname "$(readlink -e "$0")")
export UCSF_WYNTON_DIR
export UCSF_WYNTON_TOOLS=true

## Always search the same directory first
PATH="$UCSF_WYNTON_DIR:$PATH"

function mecho {
    >&2 echo "$@"
}

function mcat {
    >&2 cat "$@"
}

function list_tools {
    tools=
    for path in $(echo -e "${PATH//:/\\n}" | sort -u); do
	# shellcheck disable=SC2010,SC2086
	tools="$tools $(ls $path/wynton-* 2> /dev/null | grep -vE '(^#|~$|#$)' | sed "s|.*/wynton-||")"
    done
    echo -e "${tools// /\\n}" | sort -u | grep -vE "^$"
}

function whatis {
    local tool=${1:?}
    local pathname
    pathname="$(command -v "wynton-${tool}")"
    local res
    res=$(grep -E "^#' whatis: " "$pathname" | sed "s/^#' whatis: //")
    if [[ -z "${res}" ]]; then
        res=$(grep -E "^#' " "$pathname" | head -1 | sed "s/^#' //")
    fi
    echo "$res"
}

function table_of_tools {
    local cmd
    for cmd in $(list_tools); do
        printf " %-15s %s\\n" "$cmd" "$(whatis "$cmd")"
    done
}

version() {
    grep -E "^#'[ ]*Version:[ ]*" "$0" | sed "s/#'[ ]*Version:[ ]*//g"
}

help() {
    local t
    t=$(table_of_tools)
    t=${t//$'\n'/\\n}
    grep "^#'" "$0" | sed -E "s/^#'[[:blank:]]?//" | sed "s/{{table_of_tools}}/$t/"
}

main() {
    if [ $# -lt 1 ]; then
        help ""
        exit 1
    elif [ "$1" == "--help" ]; then
        help ""
        exit 0
    elif [ "$1" == "--version" ]; then
        version
        exit 0
    elif [ "$1" == "--tools" ]; then
        list_tools
        exit 0
    elif [ "$2" == "--whatis" ]; then
        whatis "$1"
        exit 0
    fi
    
    SUBCOMMAND="$1"; shift
    SUBCMD=$UCSF_WYNTON_DIR/wynton-$SUBCOMMAND
    if [ ! -e "$SUBCMD" ]; then
        usage
        exit 0
    fi

    $SUBCMD "$@"
}

main "$@"
